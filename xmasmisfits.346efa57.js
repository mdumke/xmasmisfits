var e={};e='*{box-sizing:border-box;margin:0;padding:0}:host{z-index:5;width:100%;height:100%;display:block;position:absolute}.open{pointer-events:none}main{width:100%;height:100%;position:relative}.door-frame{cursor:pointer;user-select:none;-webkit-user-drag:none;background-position:50%;background-repeat:no-repeat;border:5px dashed #333;border-radius:3px;justify-content:center;align-items:center;width:100%;height:100%;transition:transform 1.2s ease-out;display:flex;position:absolute;top:0;left:0}.label-container{aspect-ratio:1;justify-content:center;align-items:center;display:flex;& .label-text{width:52px;height:52px}}.content-wrapper{background-color:#222;border:1px solid #555;border-radius:2px;width:100%;height:100%;padding:8px;position:absolute;top:0;left:0;& .door-content{cursor:pointer;-webkit-user-drag:none;background-position:50%;background-repeat:no-repeat;background-size:100% 100%;border-radius:2px;justify-content:center;align-items:center;width:100%;height:100%;transition:background-size .9s ease-out;display:flex;box-shadow:inset -2px 2px 3px #0000004d;&:hover{background-size:106% 106%}}}.door-backdrop{background-color:#fff;border-radius:3px;width:100%;height:100%;position:absolute;top:0;left:0}.play-icon{cursor:pointer;background-color:#0006;border:none;border-radius:50%;width:30px;height:30px}.play-icon:before{content:"";border-top:9px solid #0000;border-bottom:9px solid #0000;border-left:14px solid #ffffffb3;width:0;height:0;position:absolute;top:50%;left:50%;transform:translate(-34%,-50%)}.hide{display:none}.shake{animation:.5s shake}@keyframes shake{0%{transform:translate(0)}20%{transform:translate(-3px)}40%{transform:translate(3px)}60%{transform:translate(-1px)}80%{transform:translate(1px)}to{transform:translate(0)}}';let t=document.createElement("template");t.innerHTML=`
  <style>${e}</style>

  <main>
    <div part="door-backdrop" class="door-backdrop">
      <loading-spinner></loading-spinner>
    </div>

    <div class="content-wrapper">
      <div id="door-content" class="door-content">
        <div id="play-icon" class="play-icon hide" tabindex="0" role="button" aria-label="Play">
        </div>
      </div>
    </div>

    <div id="door-frame" class="door-frame">
      <div class="label-container" part="label-container">
        <div id="label-text" class="label-text"></div>
      </div>
    </div>
  </main>
`;class s extends HTMLElement{static get observedAttributes(){return["preload"]}set config(e){this._config=e,this.update()}get config(){if(!this._config)throw Error("[CalendarDoor] config object not set");return this._config}set packageConfig(e){this._packageConfig=e,this.updatePackage()}get packageConfig(){if(!this._packageConfig)throw Error("[CalendarDoor] packageConfig object not set");return this._packageConfig}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(t.content.cloneNode(!0)),this.$doorFrame=this.shadowRoot.querySelector("#door-frame"),this.$doorLabel=this.shadowRoot.querySelector("#label-text"),this.$doorContent=this.shadowRoot.querySelector("#door-content")}connectedCallback(){this.dataset.interactive="",this.dataset.door="",this.update()}attributeChangedCallback(e,t,s){if("open"===e&&null!==s)return this.openDoor();this.update()}update(){this.id=this.config.id;let{top:e,left:t}=this.config.position||{},{width:s,height:i}=this.config.size||{};this.style.width=`${s}px`,this.style.height=`${i}px`,this.style.top=`${e}px`,this.style.left=`${t}px`;let n=`images/${this.config.filename}`,a=`images/door-numbers/${this.config.label}.webp`;this.$doorFrame.style.backgroundImage=`url(${n})`,this.$doorLabel.style.backgroundImage=`url(${a})`}updatePackage(){let e=this.packageConfig.thumbnail;this.$doorContent.style.backgroundImage=`url('images/${e}')`,this.$doorContent.querySelector("#play-icon").classList.remove("hide")}openIfAllowed(){this.mayOpen()&&this.open()}mayOpen(){return this.config.label,!0}shake(){this.$doorFrame.classList.remove("shake"),this.offsetWidth,this.$doorFrame.classList.add("shake")}open(){let e=this.config.size.width,t="left"===(this.config.direction||"left")?`-${e-2}px`:`${e-2}px`;this.$doorFrame.style.transform=`translateX(${t})`,this.$doorFrame.classList.add("open"),this.removeAttribute("data-door"),this.setAttribute("open","true"),this.dataset.content=""}displayContent(){this.dispatchEvent(new CustomEvent("show-player",{bubbles:!0,composed:!0,detail:{src:this.packageConfig.src}}))}}customElements.define("calendar-door",s);var i={};i="*{box-sizing:border-box;margin:0;padding:0}:host{display:block}main{cursor:grab;width:100%;height:100%;overflow:scroll;&:active{cursor:grabbing}user-select:none;-webkit-user-drag:none;scrollbar-width:none;-ms-overflow-style:none&::-webkit-scrollbar{display:none}overscroll-behavior:contain;touch-action:pan-x pan-y;-webkit-overflow-scrolling:auto}";let n=document.createElement("template");n.innerHTML=`
  <style>${i}</style>

  <main>
    <slot></slot>
  </main>
`;class a extends HTMLElement{isDown=!1;startX=0;startY=0;scrollLeft=0;scrollTop=0;constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(n.content.cloneNode(!0)),this.$container=this.shadowRoot.querySelector("main")}connectedCallback(){this.registerListeners()}disconnectedCallback(){this.removeListeners()}scrollToInitial(){let{scrollWidth:e,clientWidth:t,scrollHeight:s,clientHeight:i}=this.$container;this.$container.scrollTo((e-t)/2,(s-i)/2-60)}scrollToPosition({x:e,y:t}){this.$container.scrollTo(e,t)}startPan=e=>{e.target.closest("[data-interactive]")||(this.isDown=!0,this.$container.classList.add("active"),this.startX=e.clientX,this.startY=e.clientY,this.scrollLeft=this.$container.scrollLeft,this.scrollTop=this.$container.scrollTop)};updatePan=e=>{if(!this.isDown)return;let t=e.clientX,s=e.clientY,i=t-this.startX,n=s-this.startY;"mouse"===e.pointerType&&(this.$container.scrollLeft=this.scrollLeft-i,this.$container.scrollTop=this.scrollTop-n)};stopPan=e=>{this.isDown=!1,this.$container.classList.remove("active")};onScroll=()=>{this.dispatchPanUpdate()};dispatchPanUpdate(){this.dispatchEvent(new CustomEvent("pan-update",{bubbles:!0,composed:!0,detail:{scrollLeft:this.$container.scrollLeft,scrollTop:this.$container.scrollTop}}))}registerListeners(){this.$container.addEventListener("pointerdown",this.startPan),this.$container.addEventListener("pointerup",this.stopPan),this.$container.addEventListener("pointercancel",this.stopPan),this.$container.addEventListener("pointermove",this.updatePan),this.$container.addEventListener("scroll",this.onScroll)}removeListeners(){this.$container.removeEventListener("pointerdown",this.startPan),this.$container.removeEventListener("pointerup",this.stopPan),this.$container.removeEventListener("pointercancel",this.stopPan),this.$container.removeEventListener("pointermove",this.updatePan),this.$container.removeEventListener("scroll",this.onScroll)}}customElements.define("pan-container",a);var o={};o="*{background-origin:padding-box;margin:0;padding:0}:host{background-color:#fff;border:1px solid #222;border-radius:3px;width:100%;height:8px;display:block;overflow:hidden}.bar{background-color:#00d41c;border-right:1px solid #222;width:0%;height:100%}";let r=document.createElement("template");r.innerHTML=`
  <style>${o}</style>

  <main id="bar" class="bar" part="bar"></main>
`;class l extends HTMLElement{static get observedAttributes(){return["value","max"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(r.content.cloneNode(!0)),this.$container=this.shadowRoot.querySelector("#container"),this.$bar=this.shadowRoot.querySelector("#bar")}connectedCallback(){this.setAttribute("role","progressbar"),this.setAttribute("aria-valuemin","0"),this.update()}attributeChangedCallback(){this.update()}update(){let e=Number(this.getAttribute("max")||100),t=Math.min(Number(this.getAttribute("value")||0),e),s=0===e?0:t/e*100;this.$bar.style.width=`${s}%`,this.setAttribute("aria-valuenow",t.toString()),this.setAttribute("aria-valuemax",e.toString())}}customElements.define("progress-bar",l);var h={};h="*{box-sizing:border-box;margin:0;padding:0}:host{z-index:10;display:block;position:absolute;inset:0}.overlay{background-color:#000000d9;justify-content:center;align-items:center;width:100%;height:100%;display:flex;& iframe{aspect-ratio:16/9;border:none;width:95%;max-width:560px;max-height:315px}}.close-button{color:#fff;text-align:center;cursor:pointer;z-index:11;background-color:#00000080;border:none;border-radius:15px;width:35px;height:35px;font-size:20px;line-height:30px;position:absolute;top:10px;right:10px}";let d=document.createElement("template");d.innerHTML=`
  <style>${h}</style>

  <div part="overlay" class="overlay"></div>
  <button part="close-button" class="close-button" aria-label="Close">
    &times;
  </button>
`;class c extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(d.content.cloneNode(!0)),this.$overlay=this.shadowRoot.querySelector('[part="overlay"]'),this.$closeButton=this.shadowRoot.querySelector('[part="close-button"]')}connectedCallback(){this.classList.add("hide"),this.$overlay.addEventListener("click",this.close),this.$closeButton.addEventListener("click",this.close)}disconnectedCallback(){this.$overlay.removeEventListener("click",this.close),this.$closeButton.removeEventListener("click",this.close)}displayImage(e){let{src:t}=e.detail;this.$overlay.innerHTML=`
    <iframe
      src="${t}&autoplay=1&rel=0"
      frameborder="0"
      allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"
      referrerpolicy="strict-origin-when-cross-origin"
      allowfullscreen
    ></iframe>
    `,this.classList.remove("hide")}close=e=>{"IMG"!==e.target.tagName&&(this.classList.add("hide"),this.$overlay.innerHTML="",this.dispatchEvent(new CustomEvent("player-closed",{bubbles:!0,composed:!0})))}}customElements.define("media-player",c);var u={};u=":host{--spinner-width:3px;--spinner-size:30px;--spinner-color:#555;--spinner-background-color:#f3f3f3;width:100%;height:100%;display:block;position:relative}.spinner{width:var(--spinner-size);height:var(--spinner-size);border:var(--spinner-width)solid var(--spinner-background-color);border-top:var(--spinner-width)solid var(--spinner-color);border-radius:50%;animation:2.5s linear infinite spin;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}@keyframes spin{0%{transform:translate(-50%,-50%)rotate(0)}to{transform:translate(-50%,-50%)rotate(360deg)}}";class p extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`
      <style>${u}</style>

      <div class="spinner" part="spinner"></div>
    `}}customElements.define("loading-spinner",p);var g={};g=":host{--width:5px;--edge-opacity:.7;pointer-events:none;z-index:2;background:linear-gradient(to bottom,rgba(0,0,0,var(--edge-opacity)),#0000 var(--width),#0000 calc(100% - var(--width)),rgba(0,0,0,var(--edge-opacity))),linear-gradient(to right,rgba(0,0,0,var(--edge-opacity)),#0000 var(--width),#0000 calc(100% - var(--width)),rgba(0,0,0,var(--edge-opacity)));background-blend-mode:lighten;width:100%;height:100%;display:block;position:absolute;top:0;left:0}";class m extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`
      <style>${g}</style>
    `}}customElements.define("blur-overlay",m);var f={};f="*{box-sizing:border-box;margin:0;padding:0}:host{display:block;position:relative}.snow-canvas{z-index:2;pointer-events:none;position:absolute;top:0;left:0}::slotted(*){z-index:1;position:relative}";let b=document.createElement("template");b.innerHTML=`
  <style>${f}</style>

  <canvas class="snow-canvas"></canvas>
  <slot></slot>
`;class v{static DEFAULT_CONFIG={radius:{min:1,range:4},opacity:{min:.9,range:.1},blur:{min:3,range:1},fallSpeed:{min:.1,range:.7},driftSpeed:{baseRange:.1,depthRange:1.8},driftPhaseIncrement:{base:.01,factor:.01}};constructor(e,t={}){this.$canvas=e,this.ctx=e.getContext("2d"),this.snowflakes=[],this.running=!1,this.animate=this.animate.bind(this),this.config={...v.DEFAULT_CONFIG,...t}}start(e){this.initSnowflakes(e),this.running||(this.running=!0,this.animate())}stop(){this.running=!1}setConfig(e){this.config={...this.config,...e}}initSnowflakes(e){this.snowflakes=[];let t=this.config;for(let s=0;s<e;s++){let e=Math.random();this.snowflakes.push({depth:e,x:Math.random()*this.$canvas.width,y:Math.random()*this.$canvas.height,radius:t.radius.min+e*t.radius.range,opacity:t.opacity.min+e*t.opacity.range,blur:t.blur.min+e*t.blur.range,speed:t.fallSpeed.min+e*t.fallSpeed.range,xSpeed:(Math.random()-.5)*(t.driftSpeed.baseRange+e*t.driftSpeed.depthRange),xOffset:Math.random()*Math.PI*2})}}animate(){if(!this.running)return;let{ctx:e,$canvas:t}=this;for(let s of(e.clearRect(0,0,t.width,t.height),this.snowflakes))this.drawFlake(s),s.y+=s.speed,s.x+=s.xSpeed*Math.sin(s.xOffset),s.xOffset+=this.config.driftPhaseIncrement.base+s.depth*this.config.driftPhaseIncrement.factor,s.y>t.height&&(s.y=-s.radius,s.x=Math.random()*t.width,s.xOffset=Math.random()*Math.PI*2);requestAnimationFrame(this.animate)}drawFlake({x:e,y:t,radius:s,opacity:i,blur:n}){let a=this.ctx;a.save(),a.globalAlpha=i,a.shadowBlur=n,a.shadowColor="#006b66ff",a.fillStyle="#ffffffff",a.beginPath(),a.arc(e,t,s,0,2*Math.PI),a.fill(),a.restore()}}class w extends HTMLElement{static get observedAttributes(){return["width","height"]}get width(){return this.getAttribute("width")||300}set width(e){this.setAttribute("width",e)}get height(){return this.getAttribute("height")||150}set height(e){this.setAttribute("height",e)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(b.content.cloneNode(!0)),this.$canvas=this.shadowRoot.querySelector("canvas"),this.snowCanvas=new v(this.$canvas)}disconnectedCallback(){this.snowCanvas.stop()}attributeChangedCallback(e,t,s){"width"===e&&(this.style.width=`${s}px`,this.$canvas.width=Number(s)),"height"===e&&(this.style.height=`${s}px`,this.$canvas.height=Number(s))}startSnow(e){this.snowCanvas.start(e)}}customElements.define("snow-overlay",w);var y={};y="*{box-sizing:border-box;margin:0;padding:0}:host{cursor:pointer;z-index:6;will-change:transform;background-color:#fff;border-radius:50%;width:48px;height:48px;transition:transform .12s,box-shadow .12s;display:block;box-shadow:0 2px 6px #0000004d}.img-wrapper{pointer-events:none;justify-content:center;align-items:center;width:100%;height:100%;display:flex}img{pointer-events:none;width:60%;height:60%;display:block}";class x extends HTMLElement{static get observedAttributes(){return["on","off"]}attributeChangedCallback(e,t,s){"on"===e&&null!==s?this.hasAttribute("off")&&this.removeAttribute("off"):"off"===e&&null!==s&&this.hasAttribute("on")&&this.removeAttribute("on"),this.hasAttribute("on")||this.hasAttribute("off")||this.setAttribute("off",""),this.updateIcon()}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`
      <style>${y}</style>
      <div class="img-wrapper"><img /></div>
    `,this.$icon=this.shadowRoot.querySelector("img"),this.updateIcon(),this.addEventListener("click",this.toggle)}get on(){return this.hasAttribute("on")}set on(e){e?(this.setAttribute("on",""),this.removeAttribute("off")):(this.setAttribute("off",""),this.removeAttribute("on")),this.updateIcon()}toggle=()=>{this.on=!this.on,this.on?this.dispatchUnmute():this.dispatchMute()};dispatchMute(){let e=new CustomEvent("audio-mute",{bubbles:!0,composed:!0});this.dispatchEvent(e)}dispatchUnmute(){let e=new CustomEvent("audio-unmute",{bubbles:!0,composed:!0});this.dispatchEvent(e)}updateIcon(){let e=this.hasAttribute("on");this.$icon.src=`images/${e?"ui/volume.svg":"ui/volume-slash.svg"}`,this.$icon.alt=e?"Sound On":"Sound Off"}}customElements.define("audio-toggle",x);var k={};k="*{box-sizing:border-box;margin:0;padding:0}:host{cursor:pointer;z-index:6;will-change:transform;background-color:#fff;border-radius:50%;width:48px;height:48px;transition:transform .12s,box-shadow .12s;display:block;box-shadow:0 2px 6px #0000004d}.img-wrapper{pointer-events:none;justify-content:center;align-items:center;width:100%;height:100%;display:flex}img{pointer-events:none;width:60%;height:60%;display:block}";class E extends HTMLElement{static get observedAttributes(){return["fullscreen","windowed"]}attributeChangedCallback(e,t,s){"fullscreen"===e&&null!==s?this.hasAttribute("windowed")&&this.removeAttribute("windowed"):"windowed"===e&&null!==s&&this.hasAttribute("fullscreen")&&this.removeAttribute("fullscreen"),this.hasAttribute("fullscreen")||this.hasAttribute("windowed")||this.setAttribute("windowed",""),this.updateIcon()}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`
      <style>${k}</style>
      <div class="img-wrapper"><img /></div>
    `,this.$icon=this.shadowRoot.querySelector("img"),this.updateIcon(),this.addEventListener("click",this.toggle)}get fullscreen(){return this.hasAttribute("fullscreen")}set fullscreen(e){e?(this.setAttribute("fullscreen",""),this.removeAttribute("windowed")):(this.setAttribute("windowed",""),this.removeAttribute("fullscreen")),this.updateIcon()}toggle=()=>{this.fullscreen=!this.fullscreen,this.fullscreen?this.dispatchEnterFullScreen():this.dispatchExitFullScreen()};dispatchEnterFullScreen(){let e=new CustomEvent("enter-fullscreen",{bubbles:!0,composed:!0});this.dispatchEvent(e)}dispatchExitFullScreen(){let e=new CustomEvent("exit-fullscreen",{bubbles:!0,composed:!0});this.dispatchEvent(e)}updateIcon(){this.fullscreen?(this.$icon.src="images/ui/minimize.svg",this.$icon.alt="Exit full-screen"):(this.$icon.src="images/ui/maximize.svg",this.$icon.alt="Enter full-screen")}}customElements.define("fullscreen-toggle",E);var $={};$="*{box-sizing:border-box;margin:0;padding:0}:host{pointer-events:none;display:block;position:absolute}canvas{display:block}";class C extends HTMLElement{static get observedAttributes(){return["top","left"]}set config(e){this._config=e,this.onConfigUpdate()}get config(){if(!this._config)throw Error("[CalendarDoor] config object not set");return this._config}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=`
      <style>${$}</style>
      <canvas></canvas>
    `,this.$canvas=this.shadowRoot.querySelector("canvas"),this.ctx=this.$canvas.getContext("2d")}onTick=e=>{try{this.renderFrame(this.config.sequence[e])}catch(e){console.error("Error rendering animation frame:",e)}};async onConfigUpdate(){this.style.top=`${this.config.position.top}px`,this.style.left=`${this.config.position.left}px`,this.style.width=`${this.config.size.width}px`,this.style.height=`${this.config.size.height}px`,this.$canvas.width=this.config.size.width,this.$canvas.height=this.config.size.height,this.renderFrame(0)}renderFrame(e){let t=this.config.images[e];t&&(this.ctx.clearRect(0,0,this.$canvas.width,this.$canvas.height),this.ctx.drawImage(t,0,0,this.$canvas.width,this.$canvas.height))}}customElements.define("animation-sequence",C);let L=new class{current=null;change(e){this.current&&this.current.exit(),this.current=e,this.current.enter()}},S=new class{constructor(){this.locked=!0,this.audioCtx=null,this.masterGain=null,this.arrayBuffers={},this.audioBuffers={},this.activeSources={sounds:{},tracks:{}},this.manualPause=!1}async init(){this.audioCtx||(this.audioCtx=new AudioContext,this.masterGain=this.audioCtx.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this.audioCtx.destination),"suspended"===this.audioCtx.state&&await this.audioCtx.resume(),await this.decodeBuffers(),this.locked=!1)}get isPaused(){return!this.audioCtx||"suspended"===this.audioCtx.state}async playSound(e,{volume:t}={}){return this._play(e,"sounds",{volume:t})}async playAmbienceTrack(e,{volume:t}={}){return this._play(e,"tracks",{volume:t,loop:!0})}async stopAmbienceTrack(e){this._stop(e,"tracks")}async _play(e,t,{volume:s=1,loop:i=!1}={}){return this.audioCtx?new Promise(n=>{let a=this.audioCtx.createBufferSource();a.buffer=this.audioBuffers[e],a.loop=i;let o=this.audioCtx.createGain();o.gain.value=Math.max(0,s),a.connect(o),o.connect(this.masterGain),a.start(0),this.activeSources[t][e]={source:a,gain:o},a.onended=()=>{delete this.activeSources[t][e],n()}}):console.warn("[AudioPlayer] audio context is locked")}_stop(e,t){if(!this.audioCtx)return console.warn("[AudioPlayer] audio context locked");let s=this.activeSources[t][e];s&&s.source.stop()}register(e,t){this.arrayBuffers[e]=t}async pause(e=!1){if(!this.audioCtx)return console.warn("[AudioPlayer] cannot pause: audio context locked");"suspended"!==this.audioCtx.state&&(await this.audioCtx.suspend(),e&&(this.manualPause=!0))}async resume(e=!1){if(!this.audioCtx)return console.warn("[AudioPlayer] cannot resume: audio context locked");"running"===this.audioCtx.state&&await this.audioCtx.resume(),(!this.manualPause||e)&&(this.clearSources("sounds"),this.manualPause=!1,await this.audioCtx.resume())}clearSources(e){Object.keys(this.activeSources[e]).forEach(t=>{this._stop(t,e)})}async decodeBuffers(){if(!this.audioCtx)return console.warn("[AudioPlayer] cannot decode: audio context locked");"running"!==this.audioCtx.state&&await this.audioCtx.resume();try{await Promise.all(Object.entries(this.arrayBuffers).map(async([e,t])=>{let s=t.slice(0),i=await this.audioCtx.decodeAudioData(s);this.audioBuffers[e]=i}))}catch(e){return`Error during audio decoding: ${e.message}`}this.arrayBuffers={}}},A="stage-calendar-assets",P="stage-package-thumbnails",M="stage-complete",T=new class{loadingStage="stage-initial";progress=0;progressCallbacks=[];cachedImages={};cachedAudioBuffers={};audioInfo={};_assetMapping=null;get assetMapping(){if(!this._assetMapping)throw Error("Asset mapping not loaded yet");return Object.freeze(this._assetMapping)}get calendarAssetsReady(){return[P,M].includes(this.loadingStage)}get packageThumbnailsReady(){return this.loadingStage===M}async run(){await this.loadAssetMapping(),await this.preloadCalendarAssets(),await this.preloadPackageThumbnails(),this.loadingStage=M}registerProgressCallback(e,t){t(this.loadingStage,this.progress),this.progressCallbacks.push({key:e,cb:t})}unregisterProgressCallback(e){this.progressCallbacks=this.progressCallbacks.filter(t=>t.key!==e)}async preloadCalendarAssets(){this.loadingStage=A;let e=[this._assetMapping.background.filename,...this._assetMapping.doors.map(e=>e.filename),...this._assetMapping.ui,...this._assetMapping.animations.flatMap(({filenames:e})=>e),...this.doorNumbers()],t=this._assetMapping.audio,s=e.length+t.length,i=0;await this.preloadImages(e,()=>{i++,this.onProgress(i,s)}),await Promise.all(t.map(async({name:e,filename:t,volume:n})=>{let a=await this.loadAudio(`audio/${t}`);S.register(e,a),i++,this.audioInfo[e]={volume:n},this.onProgress(i,s)}))}doorNumbers(){let e=[];for(let t=1;t<=24;t++)e.push(`door-numbers/${t.toString()}.webp`);return e}onProgress(e,t){let s=0===t?0:Math.floor(e/t*100);this.progress=s,this.progressCallbacks.forEach(({cb:e})=>e(this.loadingStage,s,100===s))}getImage(e){let t=this.cachedImages[e];if(!t)throw Error(`[AssetLoader] image not cached: ${e}`);return t}async preloadPackageThumbnails(){this.loadingStage=P;let e=this._assetMapping.doors.map(({packageId:e})=>this._assetMapping.packages[e]?.thumbnail);await T.preloadImages(e,(e,t)=>{let s=0===t?0:Math.floor(e/t*100);this.progress=s,this.progressCallbacks.forEach(({cb:e})=>e(this.loadingStage,s,100===s))})}async preloadImages(e,t){let s=e.length,i=0,n=e.map(e=>this.preloadImage(`images/${e}`).then(n=>(this.cachedImages[e]=n,i++,t&&t(i,s),n)));await Promise.all(n)}async preloadImage(e){return new Promise((t,s)=>{let i=new Image;i.onload=()=>t(i),i.onerror=()=>s(Error(`[AssetLoader] failed to load image: ${e}`)),i.src=e})}async loadAudio(e){let t=await fetch(e);return await t.arrayBuffer()}async loadAssetMapping(){let e=await fetch("assets.json");this._assetMapping=await e.json()}async refreshImage(e){let t=this.cachedImages[e];if(!t)throw Error(`[AssetLoader] image not cached: ${e}`);try{await t.decode()}catch{}}},I="opened-doors",z="last-position",D=new class{$app=null;$animations=[];constructor(){this.$app=this.selectElement("#app")}revealCalendar(){this.selectElement("#title-screen").remove()}async renderCalendarAssets(){let e=T.assetMapping,t=this.selectElement("#snow-overlay"),s=D.selectElement("#calendar");await this.renderBackground(t,s,e),this.renderDoors(s,e),this.renderAnimations(s,e)}restoreLastPosition(){let e=function(){let e=localStorage.getItem(z);if(!e)return null;try{return JSON.parse(e)}catch{return null}}();e?this.selectElement("#pan-container").scrollToPosition(e):this.selectElement("#pan-container").scrollToInitial()}async renderBackground(e,t,{background:s}){await T.refreshImage(s.filename),e.setAttribute("width",s.width),e.setAttribute("height",s.height),t.style.backgroundImage=`url('images/${s.filename}')`,t.style.width=`${s.width}px`,t.style.height=`${s.height}px`}startSnow(e){this.selectElement("#snow-overlay").startSnow(e)}renderDoors(e,{doors:t}){e.innerHTML="",t.forEach(t=>e.appendChild(this.buildDoorElement(t)))}renderAnimations(e,{animations:t}){t.forEach(t=>{let s=document.createElement("animation-sequence");s.config={...t,images:t.filenames.map(e=>T.getImage(e))},e.appendChild(s),this.$animations.push(s)})}updateAnimations(e){this.$animations.forEach(t=>{t.onTick(e)})}reopenDoors(e={}){Object.keys(e).forEach(e=>{this.selectElement(`#${e}`).open()})}buildDoorElement(e){let t=document.createElement("calendar-door");return t.config=e,t}handleForbiddenDoor(e){e.shake(),this.playSound("forbidden")}async playSound(e){S.isPaused||await S.playSound(e,{volume:T.audioInfo[e]?.volume||1})}playAmbience(){S.playAmbienceTrack("wind")}stopAmbience(){S.stopAmbienceTrack("wind")}updateProgressBar(e,t,s=2){e.setAttribute("value",Math.max(t,s))}configurePackages(){T.assetMapping.doors.forEach(e=>{D.selectElement(`#${e.id}`).packageConfig=T.assetMapping.packages[e.packageId]})}enterFullscreen(){document.fullscreenElement||this.$app.requestFullscreen()}exitFullscreen(){document.fullscreenElement&&document.exitFullscreen()}selectElement(e){let t=document.querySelector(e);if(!t)throw Error(`UI element not found: ${e}`);return t}},F=new class{dt=0;counter=0;maxCounter=8;cutoff=2/8*1e3;prevTime=0;ref=0;run=e=>{this.prevTime>0&&(this.dt+=e-this.prevTime,this.dt>=this.cutoff&&(this.dt%=this.cutoff,this.counter=(this.counter+1)%this.maxCounter,this.tick())),this.prevTime=e,this.ref=requestAnimationFrame(this.run)};tick(){document.dispatchEvent(new CustomEvent("tick",{detail:{i:this.counter}}))}};class R{key="calendar-context";openedDoors={};$calendar=null;constructor(){this.startX=0,this.startY=0,this.dx=0,this.dy=0,this.walkX=0,this.walkY=0,this.maxX=2560,this.maxY=1440,this.borderSize=50,this.dragging=!1}async enter(){this.openedDoors=function(){let e=localStorage.getItem(I);if(!e)return{};try{return JSON.parse(e)}catch{return{}}}(),await this.render(),this.player=D.selectElement("#media-player"),this.$calendar=D.selectElement("#calendar"),this.$frame=D.selectElement("#panic-container"),this.$content=D.selectElement(".pan-content"),this.setStartPosition(1100,200),this.registerListeners(),this.prepareContentPackages(),this.startAnimationTimer(),D.revealCalendar()}exit(){this.removeListeners()}async render(){await D.renderCalendarAssets(),D.reopenDoors(this.openedDoors),D.startSnow(400),await S.decodeBuffers(),D.playAmbience()}onCalendarClick=e=>{let t=e.target.closest("[data-door]");if(t)return e.preventDefault(),this.onDoorClick(t);let s=e.target.closest("[data-content]");s&&s.displayContent()};onDoorClick(e){let t;if(!e.mayOpen())return D.handleForbiddenDoor(e);this.openedDoors[e.id]=!0,t=JSON.stringify(this.openedDoors),localStorage.setItem(I,t),e.open(),D.playSound("door")}onShowPlayer=e=>{D.stopAmbience(),this.player.displayImage(e)};onPlayerClosed=()=>{D.playAmbience()};onAudioMute=async()=>{await D.playSound("click"),S.pause(!0)};onAudioUnmute=()=>{D.playSound("click"),S.resume(!0)};onEnterFullscreen=()=>{D.enterFullscreen()};onExitFullscreen=()=>{D.exitFullscreen()};onVisibilityChange=()=>{document.hidden?S.pause():S.resume()};onTick=e=>{D.updateAnimations(e.detail.i)};onKeyDown=e=>{"Space"===e.code&&e.preventDefault()};onPanUpdate=e=>{let t;t=JSON.stringify({x:e.detail.scrollLeft,y:e.detail.scrollTop}),localStorage.setItem(z,t)};prepareContentPackages(){T.packageThumbnailsReady?D.configurePackages():T.registerProgressCallback(this.key,this.onLoadingProgress)}onLoadingProgress=(e,t,s)=>{e!==P||s&&(T.unregisterProgressCallback(this.key),D.configurePackages())};startAnimationTimer(){F.run()}setStartPosition(e,t){this.shift(-e,-t),this.dx=-e,this.dy=-t,this.walkX=0,this.walkY=0}shift(e,t){let s=this.$frame.clientWidth||window.innerWidth;this.walkX=Math.min(e,-this.dx+this.borderSize),this.walkX=Math.max(this.walkX,s-this.borderSize-this.maxX-this.dx);let i=this.$frame.clientHeight||window.innerHeight;this.walkY=Math.min(t,-this.dy+this.borderSize),this.walkY=Math.max(this.walkY,i-this.borderSize-this.maxY-this.dy);let n=this.dx+this.walkX,a=this.dy+this.walkY;this.$content.style.transform=`translate(${n}px, ${a}px)`}onWindowResize=()=>{this.shift(this.walkX,this.walkY)};onPointerDown=e=>{e.composedPath().some(e=>e?.hasAttribute?.("data-door"))||e.composedPath().some(e=>e?.hasAttribute?.("data-content"))||(this.dragging=!0,this.$frame.setPointerCapture(e.pointerId),this.startX=e.clientX,this.startY=e.clientY)};onPointerMove=e=>{this.dragging&&this.shift(e.clientX-this.startX,e.clientY-this.startY)};onDragEnd=e=>{this.dragging=!1,this.dx+=this.walkX,this.dy+=this.walkY,this.walkX=0,this.walkY=0,this.$frame.releasePointerCapture(e.pointerId)};registerListeners(){this.$calendar.addEventListener("click",this.onCalendarClick),document.addEventListener("show-player",this.onShowPlayer),document.addEventListener("player-closed",this.onPlayerClosed),document.addEventListener("audio-mute",this.onAudioMute),document.addEventListener("audio-unmute",this.onAudioUnmute),document.addEventListener("enter-fullscreen",this.onEnterFullscreen),document.addEventListener("exit-fullscreen",this.onExitFullscreen),document.addEventListener("visibilitychange",this.onVisibilityChange),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("tick",this.onTick),document.addEventListener("pan-update",this.onPanUpdate),this.$frame.addEventListener("pointerdown",this.onPointerDown),this.$frame.addEventListener("pointermove",this.onPointerMove),this.$frame.addEventListener("pointerup",this.onDragEnd),this.$frame.addEventListener("pointercancel",this.onDragEnd),window.addEventListener("resize",this.onWindowResize)}removeListeners(){this.$calendar.removeEventListener("click",this.onCalendarClick),document.removeEventListener("show-player",this.onShowPlayer),document.removeEventListener("player-closed",this.onPlayerClosed),document.removeEventListener("audio-mute",this.onAudioMute),document.removeEventListener("audio-unmute",this.onAudioUnmute),document.removeEventListener("enter-fullscreen",this.onEnterFullscreen),document.removeEventListener("exit-fullscreen",this.onExitFullscreen),document.removeEventListener("visibilitychange",this.onVisibilityChange),document.removeEventListener("keydown",this.onKeyDown),document.removeEventListener("tick",this.onTick),document.removeEventListener("pan-update",this.onPanUpdate),this.$frame.removeEventListener("pointerdown",this.onPointerDown),this.$frame.removeEventListener("pointermove",this.onPointerMove),this.$frame.removeEventListener("pointerup",this.onDragEnd),this.$frame.removeEventListener("pointercancel",this.onDragEnd),window.removeEventListener("resize",this.onWindowResize)}}class B{key="title-context";loadingProgress=0;autoSwitch=!1;$startBtn=null;$progressBar=null;enter(){this.$startBtn=D.selectElement("#start-button"),this.$progressBar=D.selectElement("#progress-bar"),T.registerProgressCallback(this.key,this.onLoadingProgress),T.run(),this.registerListeners()}exit(){this.removeListeners()}onLoadingProgress=(e,t,s)=>{e!==A||(this.loadingProgress=t,!this.autoSwitch||(this.updateProgressBar(),s&&(T.unregisterProgressCallback(this.key),setTimeout(this.goToCalendar,1200))))};onStartClick=()=>{T.calendarAssetsReady?this.goToCalendar():this.waitForPreload()};waitForPreload=()=>{this.$startBtn.classList.add("hide"),this.$progressBar.classList.remove("hide"),this.autoSwitch=!0,setTimeout(this.updateProgressBar,0)};goToCalendar=()=>{L.change(new R)};updateProgressBar=()=>{D.updateProgressBar(this.$progressBar,this.loadingProgress)};registerListeners(){this.$startBtn.addEventListener("click",this.onStartClick)}removeListeners(){this.$startBtn.removeEventListener("click",this.onStartClick)}}document.addEventListener("DOMContentLoaded",()=>{"#reset"===location.hash&&localStorage.clear(),L.change(new B)},{once:!0});let _=()=>{S.init(),document.removeEventListener("click",_)};document.addEventListener("click",_);
//# sourceMappingURL=xmasmisfits.346efa57.js.map
